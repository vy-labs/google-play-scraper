import json
from typing import Any, Dict

from google_play_scraper.constants.element import ElementSpecs
from google_play_scraper.constants.regex import Regex
from google_play_scraper.constants.request import Formats
from google_play_scraper.utils.request import get
from google_play_scraper.exceptions import NotFoundError


def app(app_id: str, lang: str = "en", country: str = "us") -> Dict[str, Any]:
    url = Formats.Detail.build(app_id=app_id, lang=lang, country=country)

    try:
        dom = get(url)
    except NotFoundError:
        url = Formats.Detail.fallback_build(app_id=app_id, lang=lang)
        dom = get(url)
    return parse_dom(dom=dom, app_id=app_id, url=url)


def parse_dom(dom: str, app_id: str, url: str) -> Dict[str, Any]:
    matches = Regex.SCRIPT.findall(dom)

    dataset = {}

    for match in matches:
        key_match = Regex.KEY.findall(match)
        value_match = Regex.VALUE.findall(match)

        if key_match and value_match:
            key = key_match[0]
            value = json.loads(value_match[0])

            dataset[key] = value

    result = {}

    for k, spec in ElementSpecs.Detail.items():
        if isinstance(spec, list):
            for sub_spec in spec:
                content = sub_spec.extract_content(dataset)

                if content is not None:
                    result[k] = content
                    break
        else:
            content = spec.extract_content(dataset)

            result[k] = content

    result["appId"] = app_id
    result["url"] = url

    return result
[None, None, [['Meesho: Online Shopping App'], None, None, None, None, None, None, None, [False, True, [False]], ['Everyone', [None, 2, [512, 512], [None, None, 'https://play-lh.googleusercontent.com/IciOnDFecb5Xt50Q2jlcNC0LPI7LEGxNojroo-s3AozcyS-vDCwtq4fn7u3wZmRna8OewG9PBrWC-i7i']], None, None, [None, '<a href="https://support.google.com/googleplay?p=appgame_ratings">Learn more</a>'], False, [None, 'Content is generally suitable for all ages. May contain minimal cartoon, fantasy or mild violence and/or infrequent use of mild language.'], [None, 2, [272, 272], [None, None, 'https://play-lh.googleusercontent.com/OBVqgRK7eerY0GPfK8AOzitu5oE9ecC6kG4kURTCb1K41gpqVsN0WjmJwJh-wX8vILzpcc1kYHt56aLN2g']], [None, None, None, None, None, [None, None, 'https://support.google.com/googleplay?p=appgame_ratings']]], ['Feb 16, 2017', [1487254434, 186000000]], None, None, ['100,000,000+', 100000000, 448477992, '100M+'], None, None, None, None, [2], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ['Meesho'], None, None, None, None, [1, True, False], None, None, None, None, None, ['Contains ads'], None, None, [['4.0', 4.0149574], [None, ['652,631', 652631], ['144,671', 144671], ['152,709', 152709], ['362,483', 362483], ['2,458,620', 2458620]], ['3,772,724', 3772724], ['1,511', 1511], None, [None, []]], None, None, None, None, None, [[[[[None, [[0, 'USD', '']], None, [None, 'Buy'], None, 1, [None, None, None, None, None, [None, None, 'https://play.google.com/store/apps/details?id=com.meesho.supply&rdid=com.meesho.supply&feature=md&offerId']], None, ['CAE='], None, None, None, None, None, None, None, []]], ['Install'], None, ['CgYKBENBRT0=']]]], None, None, None, None, None, None, None, None, None, None, ['Meesho', [None, None, None, None, [None, None, '/store/apps/developer?id=Meesho']], '8586507075174719506'], [[None, None, None, None, None, [None, None, 'https://www.meesho.com/']], ['query@meesho.com'], None, '+918061799600'], None, None, [[None, 'Meesho: India’s Favourite One-stop Online Shop<br><br>You can now shop for yourself or earn money online, both using the same Meesho App! <br><br>Meesho offers stylish top quality lifestyle products at the lowest wholesale prices, allowing you to shop online at any budget. Besides shopping, you can also resell products to your friends and family. Start your Online Business with Zero Investment today! Work from home and earn money online with just a phone. If you are wondering what makes Meesho the top online shopping app, take a look at the list below.<br><br><br>1. High-Quality Products at Lowest Prices <br>Place your orders from an amazing network of wholesalers across India that supply the best fashion and lifestyle products, at prices you will love.Since all the products on the Meesho app are sourced directly from suppliers and manufacturers, you will get them at lowest prices.<br><br>2.  Free Delivery/ Free Shipping<br>Meesho offers Free Delivery on all orders with no minimum order value. So everyone can buy best quality products at lowest prices on meesho without any hassle<br><br>3. Cash On Delivery (COD) Available <br>Meesho products are available for Cash On Delivery (COD). You can choose to pay after receiving the product.<br><br>4. Free Returns/Refunds<br>We offer a 7-Day Free Return &amp; Refund Policy with which you will get the money back, no questions asked. With these policies, online shopping and earning money through reselling is a safe experience!<br><br>5. 100% Safe &amp; Timely Payments <br>Our payment gateways are safe, secure &amp; quick for online payments. Your online transactions and payment details are safeguarded.Your commission is transferred automatically into your bank account, thrice a month. <br><br><br>Huge Variety Of Products In Every Category<br><br>If you are looking for good quality products at lowest  prices, you are at the right place.Choose from over 5 Crore  top quality products from categories like women’s fashion, men’s fashion, latest kid’s fashion, accessories, home &amp; kitchen essentials, beauty &amp; health essentials, etc. <br><br>From women’s ethnic wear like Sarees, Lehengas, Kurtas, and Blouses to Western Dresses, Accessories, Bags, Footwear, and Jewellery, our fashion and lifestyle collection has everything. You will also find the latest apparel and accessories for men in our collection including ethnic wear for men (Kurtas, Kurta sets, suits, Sherwani sets and more. You will also find trendy men’s Western wear (Jeans, Trousers, Shirts, T-shirts, Winterwear etc).  But that’s not all we have to offer!  From basic kitchen accessories &amp; home decor items to daily use products &amp; electronic items, you will find everything here. <br><br>How to Shop on the Meesho App<br><br>Download the Meesho App to shop for products in different categories. Meesho online App offers you the lowest wholesale prices on products, which are sourced directly from suppliers. <br><br>You can buy anything for your household needs. With shopping options under ₹99, ₹200, ₹500, Meesho app is the perfect shopping partner.<br><br>How to Resell on the Meesho App and Earn Money(in 3 simple steps)<br><br>1. Browse - Sign up on Meesho to browse through a variety of stylish high quality lifestyle products at wholesale prices.<br><br>2. Share - Once you find a product you want to sell, share it with your friends, family and existing customer networks on Whatsapp, Instagram and Facebook to start getting orders.<br><br>3. Earn - Once you get orders, add your profit margin to the wholesale price of the products, collect the payment from your customer, and place orders for them. In case of Cash On Delivery (COD), your profit margin will be transferred to your bank account. <br><br><br>So, what are you waiting for? Start shopping online or earning money online now! Have A Happy Online Shopping Experience and A Successful Reselling Journey!']], [[None, 'Online Shopping &amp; Reselling - Shop Fashion, Home, Kitchen etc. at Lowest Prices']], [None, None, [[['Contacts', [None, 2, None, [None, None, 'https://play-lh.googleusercontent.com/c5fJsmDZCeHY1tZmeGXL12sHi8herULd72A_egjaAHylmgM-4gLiw4CuDJSzNnK5q8yxAAy4RyxtkdYzcg']], [[None, 'read your contacts'], [None, 'modify your contacts']], ['contacts']], ['Location', [None, 2, None, [None, None, 'https://play-lh.googleusercontent.com/4rkEm_eN4F8lAtqf1avrqAQ49_IjMjRduxI5szmftCXmKzSaLsNScjM5DSGQp2qtI5R_fqj8j7aJi_G3dg']], [[None, 'approximate location (network-based)'], [None, 'precise location (GPS and network-based)']], ['location_on']], ['Storage', [None, 2, None, [None, None, 'https://play-lh.googleusercontent.com/aWNKQedLTpw6u6yyMjQObmuoKu67A1czWnIcvID86oAmMT02r5mNdRn6l9ZN2t2MIyH6tNy-01v7ukeQ']], [[None, 'read the contents of your USB storage'], [None, 'modify or delete the contents of your USB storage']], ['storage']], ['Microphone', [None, 2, None, [None, None, 'https://play-lh.googleusercontent.com/daUjqbSOr2QpaqXS2HQbNzYzzqN2yWGzM_7AZxwFaWLT7_kIhX95HKi_HSpjeeQDOmFMENZxJqblbu_4qg']], [[None, 'record audio']], ['perm_camera_mic']], ['Wi-Fi connection information', [None, 2, None, [None, None, 'https://play-lh.googleusercontent.com/U-_SG8pHTsqU_IyZTGQRkVMdLaAUeq1OnKGrB06KHF1z7vkkIQK3iF0HcbfTe1RnGlh-ajnZkbphl2W3Gdk']], [[None, 'view Wi-Fi connections']], ['signal_wifi_4_bar']], ['Photos/Media/Files', [None, 2, None, [None, None, 'https://play-lh.googleusercontent.com/pHtIujPWxciAZcfYSwlrGGq14Z984rKLMgcm9RPATLiOlbrWy-tVlelEWgED7gpktgcD1tZizVeHiO5fkw']], [[None, 'read the contents of your USB storage'], [None, 'modify or delete the contents of your USB storage']], ['perm_media']]], [['Other', [None, 2, None, [None, None, 'https://play-lh.googleusercontent.com/pkKXoPl5q7n8T0s7KREtdvUZn1PLRgx-Ox0t4tkO8af4JpgGbyAxLBTsvEKKBCjwBACQsZisSYNmHPGbBA']], [[None, 'full network access'], [None, 'pair with Bluetooth devices'], [None, 'read Google service configuration'], [None, 'prevent device from sleeping'], [None, 'view network connections'], [None, 'run at startup'], [None, 'control vibration'], [None, 'reorder running apps']], ['quiz']]], [[None, 'receive data from Internet']]]], None, None, ['com.meesho.supply'], [[[None, 2, [1920, 1080], [None, None, 'https://play-lh.googleusercontent.com/mPqYrao16LIs4SPnJngCSKATeSZNDNB_zzitYgl6JBRFLbf8oiMlIoPRo7TD1tQNPw']], [None, 2, [1920, 1080], [None, None, 'https://play-lh.googleusercontent.com/6LZIFPeBtUgA3-aao8oc0WuZAY7o4oI9DD_5ITaVK3zzisQGw1mAc5GeEHhr-3f4m-Aj']], [None, 2, [1920, 1080], [None, None, 'https://play-lh.googleusercontent.com/XRJlIzl8qwOtUt1IlBpGZTYwyYWulm5RVgl3UvY3lnWkbGzlzu0gdQ5YFLB_hlQVFsLo']], [None, 2, [1920, 1080], [None, None, 'https://play-lh.googleusercontent.com/8jEfa168fzbYdQHd7mwNfeGZsHJkCMGD-E-1SJJQRsBuNW9EWW5ALDhfBr9nDSBgXWlC']], [None, 2, [1920, 1080], [None, None, 'https://play-lh.googleusercontent.com/1rMJY53g7SF1FBk7sRJVbU-W9EP05W7ho_XF17DMSincMcJap4t0_HaOOGBOX6lIo6k']], [None, 2, [1920, 1080], [None, None, 'https://play-lh.googleusercontent.com/-ddEzTCqGm7n9sEOlKM5hfoFXPS0j2cPrrcvYOMq-mSf7t-ACWB4VKIlPwoi8Q3W6vk']], [None, 2, [1920, 1080], [None, None, 'https://play-lh.googleusercontent.com/UZw7Wzm8YyeFLu5N8NLj8qztR3tYknqzAR96wadKUddv0gT8dKIOJBjG0gkQFuwNVA']], [None, 2, [1920, 1080], [None, None, 'https://play-lh.googleusercontent.com/TOaxWUauo2axJbNmx-_pzdaxteoI8ip2j23zqys4PCVMcHOPIzB4aJ_IcJ1QUpkVOPDf']]]], [[['Shopping', [None, None, None, None, [None, None, '/store/apps/category/SHOPPING']], 'SHOPPING']]], None, None, None, None, None, None, None, None, None, None, None, [['CAESQggFIhkSFwoRY29tLm1lZXNoby5zdXBwbHkQARgDWhMI/Iv3kZvuggMVGlRoCh0ijAwZggENCAASCQoFZW4tVVMQAKoCPAo6CgxERVRBSUxTX1BBR0USKgoXChFjb20ubWVlc2hvLnN1cHBseRABGAMaDwoNCAASCQoFZW4tVVMQAA=='], ['CAIaQgoZEhcKEWNvbS5tZWVzaG8uc3VwcGx5EAEYAxAAMhMI/Iv3kZvuggMVGlRoCh0ijAwZigENCAASCQoFZW4tVVMQAKoCRhpECAASGQoXChFjb20ubWVlc2hvLnN1cHBseRABGANKEwj8i/eRm+6CAxUaVGgKHSKMDBn6AQ8KDQgAEgkKBWVuLVVTEAA='], ['CAESMggtIhkSFwoRY29tLm1lZXNoby5zdXBwbHkQARgDWhMI/Iv3kZvuggMVGlRoCh0ijAwZqgI3CjUKF09ORV9DTElDS19TTUFMTF9PVkVSTEFZygIZChcKEWNvbS5tZWVzaG8uc3VwcGx5EAEYAw==']], None, None, None, [[None, 2, [512, 512], [None, None, 'https://play-lh.googleusercontent.com/8F-0kIQuTleN9DD43WlxIz-4mqmPJ3-978fr1vYF0q_QoZRrlaD3znctc4kWguHdhUCU'], None, [88, 9, 70, 255], None, None, None, 2], 2], [[None, 2, [500, 1024], [None, None, 'https://play-lh.googleusercontent.com/Xx9mfe0lod-k6oxksRDvum0-lkEY8ibe-eobm-wlgoUW4lwABB36Emo41BKcO6_WYw'], None, [87, 9, 70, 255]]], None, None, [[None, None, None, None, None, [None, None, 'https://meesho.com/legal/privacy']]], [[[None, None, 'PxQ-GWBBEn0', [None, None, 'https://www.youtube.com/embed/PxQ-GWBBEn0?ps=play&vq=large&rel=0&autohide=1&showinfo=0'], 'yt:movie:PxQ-GWBBEn0'], [None, None, None, [None, None, 'https://i.ytimg.com/vi/PxQ-GWBBEn0/hqdefault.jpg']]], [[None, 2, [500, 1024], [None, None, 'https://play-lh.googleusercontent.com/Xx9mfe0lod-k6oxksRDvum0-lkEY8ibe-eobm-wlgoUW4lwABB36Emo41BKcO6_WYw'], None, [87, 9, 70, 255]]]], None, [], None, None, None, None, None, None, None, None, [3, None, None, None, None, [], 1, []], None, None, None, None, None, None, [None, None, [], [], None, [], None, [], [], []], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, [[None, [True, True]], [[[None, 2, None, [None, None, 'https://play-lh.googleusercontent.com/iFstqoxDElUVv4T3KxkxP3OTcuFvWF5ZQQjT7aIxy4n2uaVigCCykxeG6EZV9FQ10X1itPj1oORm'], None, None, None, None, None, None, [None, None, 'https://play-lh.googleusercontent.com/haCjMpwXoqbJeotHYbcTPkZ6oJX-ENIEbGMpgoJRd18DcZBVXaVpqtBOQQobCmzUKRX5oycL8Qw']], 'This app may share these data types with third parties', [None, 'Location, Personal info and 3 others']], [[None, 2, None, [None, None, 'https://play-lh.googleusercontent.com/12USW7aflgz466ifDehKTnMoAep_VHxDmKJ6jEBoDZWCSefOC-ThRX14Mqe0r8KF9XCzrpMqJts'], None, None, None, None, None, None, [None, None, 'https://play-lh.googleusercontent.com/KUnvVSJGOe7oq-qW-E5kFNOMgfk4GkOp7wEyi6tVFOkrUJJzYSH-Gxr_nto-DH5VMBjLIFGRaMA']], 'This app may collect these data types', [None, 'Location, Personal info and 6 others']], [[None, 2, None, [None, None, 'https://play-lh.googleusercontent.com/W5DPtvB8Fhmkn5LbFZki_OHL3ZI1Rdc-AFul19UK4f7np2NMjLE5QquD6H0HAeEJ977u3WH4yaQ'], None, None, None, None, None, None, [None, None, 'https://play-lh.googleusercontent.com/zZBup5-kH4XA1ah4KQhyK5zK1z5_oHdN4H9eqXGC4O4CpfVWHzBvgJSL-T-xcQO54gCeNS33gw']], 'Data is encrypted in transit'], [[None, 2, None, [None, None, 'https://play-lh.googleusercontent.com/ohRyQRA9rNfhp7xLW0MtW1soD8SEX45Oec7MyH3FaxtukWUG_6GKVpvh3JiugzryLi7Bia02HPw'], None, None, None, None, None, None, [None, None, 'https://play-lh.googleusercontent.com/N6JWKL8wk5_U9DgAQ9iNJY7R_4wd4PG71_lQX97JVU4tq5wKBG2MmjNmbeGLQLFkSMsJkYNufrx6']], 'You can request that data be deleted']]], None, None, None, [[['16.8']], [[[33]], [[[21, '5.0']]]]], None, None, None, [None, [None, 'Greetings Meesho Users,<br>Coming off the festive cheer, we&#39;ve redefined your shopping adventure! Meesho app is now turbocharged, promising an immersive, seamless journey. Say hello to effortless browsing, quicker transactions, and a smoother interface. Shop smarter, easier, and more delightfully after the celebration! Happy shopping!!']], [['Nov 30, 2023', [1701400181, 583000000]]], None, None, None, None, [[2, 3, 5, 6]], None, None, None, [None, []]], None, None, None, None, None, None, None, None, [['com.meesho.supply', 7]], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, [[10, 11, 13, 14, 19, 20, 49, 52, 69, 70, 73, 74, 75, 78, 79, 91, 92, 95, 96, 97, 100, 101, 106, 112, 137, 141, 146, 155, 1, 38, 103, 9, 43, 80, 145, 119, 151, 58, 59, 63]]]
